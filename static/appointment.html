<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Video Call</title>
  <style>
    /* –°–±—Ä–æ—Å –∏ —Ç–µ–ª–æ */
    * { box-sizing:border-box; margin:0; padding:0; }
    html, body { width:100%; height:100%; background:#000; overflow:hidden; }
    body { display:flex; font-family:Arial,sans-serif; }

    /* –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å */
    .video-container {
      position:relative; flex:1; display:grid; place-items:center;
      background:#000;
    }
    video {
      width:100%; height:100%; object-fit:cover; background:#000;
    }
    .local {
      position:absolute; bottom:80px; right:20px;
      width:160px; height:120px; border:2px solid #fff;
      border-radius:8px; overflow:hidden; background:#222;
    }
    .local video { width:100%; height:100%; }

    /* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
    .controls {
      position:absolute; bottom:20px; left:50%;
      transform:translateX(-50%); display:flex; gap:16px;
      background:rgba(0,0,0,0.5); padding:8px 16px;
      border-radius:32px;
    }
    .controls button {
      width:48px; height:48px; border:none; border-radius:50%;
      font-size:20px; cursor:pointer; background:#fff;
      display:flex; align-items:center; justify-content:center;
    }
    .controls button.end {
      background:#e53935; color:#fff;
    }
  </style>
</head>
<body>

  <div class="video-container">
    <!-- –£–¥–∞–ª—ë–Ω–Ω–æ–µ –≤–∏–¥–µ–æ -->
    <video id="remote" autoplay playsinline></video>
    <!-- –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ -->
    <div class="local">
      <video id="local" autoplay muted playsinline></video>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="controls">
      <button id="toggleMic">üé§</button>
      <button id="toggleCamera">üì∑</button>
      <button id="endCall" class="end">‚èπÔ∏è</button>
    </div>
  </div>

  <script>
  (async () => {
    const p = new URLSearchParams(location.search);
    const apptID = p.get("id");
    const role   = p.get("role") || "patient";
    const wsUrl  = `${location.protocol.replace("http","ws")}//${location.host}` +
                   `/ws?appointment_id=${apptID}&role=${role}`;

    console.log("‚ñ∂Ô∏è init", { apptID, role, wsUrl });

    // 1) RTCPeerConnection + –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });
    pc.onicegatheringstatechange = () =>
      console.log("üïµÔ∏è‚Äç ICE gathering state:", pc.iceGatheringState);
    pc.oniceconnectionstatechange = () =>
      console.log("üîó ICE connection state:", pc.iceConnectionState);
    pc.onconnectionstatechange = () =>
      console.log("üåê PeerConnection state:", pc.connectionState);
    pc.onicecandidate = ({candidate}) => {
      console.log("üì® candidate event:", candidate);
      if (candidate && ws.readyState === 1) {
        ws.send(JSON.stringify({type:"candidate",data:candidate}));
      }
    };
    pc.ontrack = e => {
      console.log("üëÄ got remote track", e.streams[0]);
      document.getElementById("remote").srcObject = e.streams[0];
    };
    pc.onnegotiationneeded = () =>
      console.log("üîÑ negotiationneeded");

    // 2) –ó–∞—Ö–≤–∞—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
    let localStream;
    try {
      localStream = await navigator.mediaDevices
        .getUserMedia({video:true,audio:true});
      console.log("üìπ got localStream", localStream);
      document.getElementById("local").srcObject = localStream;
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    } catch (e) {
      return console.error("‚ùå getUserMedia failed", e);
    }

    // 3) –°–∏–≥–Ω–∞–ª–∏–Ω–≥
    const ws = new WebSocket(wsUrl);
    ws.onopen = async () => {
      console.log("üîó WS open");
      if (role === "doctor") {
        console.log("üë®‚Äç‚öïÔ∏è role=doctor creating offer");
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        console.log("üì® send offer", offer);
        ws.send(JSON.stringify({type:"offer",data:offer}));
      }
    };
    ws.onmessage = async ({data}) => {
      const msg = JSON.parse(data);
      console.log("üì• WS message", msg);
      if (msg.type === "offer") {
        console.log("üëÇ received offer");
        await pc.setRemoteDescription(msg.data);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        console.log("üì® send answer", answer);
        ws.send(JSON.stringify({type:"answer",data:answer}));
      }
      else if (msg.type === "answer") {
        console.log("üëÇ received answer");
        await pc.setRemoteDescription(msg.data);
      }
      else if (msg.type === "candidate") {
        console.log("üëÇ received candidate", msg.data);
        try { await pc.addIceCandidate(msg.data); }
        catch(e){ console.warn("‚ö†Ô∏è addIceCandidate failed", e); }
      }
    };
    ws.onerror = e => console.error("üö® WS error", e);
    ws.onclose = () => console.log("üîå WS closed");

    // 4) –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    document.getElementById("toggleMic").onclick = () => {
      const t = localStream.getAudioTracks()[0];
      t.enabled = !t.enabled;
      console.log("üé§ mic toggled:", t.enabled);
      document.getElementById("toggleMic").style.opacity = t.enabled? "1":"0.5";
    };
    document.getElementById("toggleCamera").onclick = () => {
      const t = localStream.getVideoTracks()[0];
      t.enabled = !t.enabled;
      console.log("üì∑ camera toggled:", t.enabled);
      document.getElementById("toggleCamera").style.opacity = t.enabled? "1":"0.5";
    };
    document.getElementById("endCall").onclick = () => {
      pc.close();
      ws.close();
      console.log("‚èπ call ended");
    };
  })();
  </script>
</body>
</html>
