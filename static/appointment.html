<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Video Call</title>
</head>
<body>
  <video id="local"  autoplay muted
         style="width:240px;height:180px;border:1px solid #666"></video>
  <video id="remote" autoplay
         style="width:240px;height:180px;border:1px solid #666"></video>

  <script>
    (async function() {
      const params = new URLSearchParams(location.search);
      const apptID = params.get("id");
      const role   = params.get("role") || "patient";
      const wsUrl  = `${location.protocol.replace("http","ws")}//${location.host}`
                   + `/ws?appointment_id=${apptID}&role=${role}`;

      console.log("â–¶ï¸ init", { apptID, role, wsUrl });

      // 1) ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ RTCPeerConnection Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      pc.onicecandidate = e => {
        if (e.candidate) {
          console.log("ðŸ“¨ send candidate", e.candidate);
          ws.send(JSON.stringify({ type: "candidate", data: e.candidate }));
        }
      };

      pc.ontrack = e => {
        console.log("ðŸ‘€ got remote track", e.streams[0]);
        document.getElementById("remote").srcObject = e.streams[0];
      };

      // 2) Ð—Ð°Ñ…Ð²Ð°Ñ‚Ð¸Ð¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð²Ð¸Ð´ÐµÐ¾/Ð°ÑƒÐ´Ð¸Ð¾ Ð¸ ÑÑ€Ð°Ð·Ñƒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ñ‚Ñ€ÐµÐºÐ¸
      let stream;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        console.log("ðŸ“¹ got local stream", stream);
        document.getElementById("local").srcObject = stream;
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
      } catch (err) {
        return console.error("âŒ getUserMedia failed", err);
      }

      // 3) ÐŸÐ¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾ ÐºÐ°Ðº Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº Ð¿Ñ€Ð¾Ð¿Ð¸ÑÐ°Ð½ Ð² pc â€” Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ WebSocket
      const ws = new WebSocket(wsUrl);

      ws.onopen = async () => {
        console.log("ðŸ”— WS open");
        if (role === "doctor") {
          console.log("ðŸ‘¨â€âš•ï¸ role=doctor â†’ createOffer");
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          console.log("ðŸ“¨ send offer", offer);
          ws.send(JSON.stringify({ type: "offer", data: offer }));
        }
      };

      ws.onmessage = async ev => {
        const msg = JSON.parse(ev.data);
        console.log("ðŸ“¥ ws.onmessage", msg);
        if (msg.type === "offer") {
          console.log("ðŸ‘‚ got offer â†’ createAnswer");
          await pc.setRemoteDescription(msg.data);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          console.log("ðŸ“¨ send answer", answer);
          ws.send(JSON.stringify({ type: "answer", data: answer }));
        } else if (msg.type === "answer") {
          console.log("ðŸ‘‚ got answer â†’ setRemoteDescription");
          await pc.setRemoteDescription(msg.data);
        } else if (msg.type === "candidate") {
          console.log("ðŸ‘‚ got candidate â†’ addIceCandidate");
          try {
            await pc.addIceCandidate(msg.data);
          } catch (e) {
            console.warn("âš ï¸ addIceCandidate failed", e);
          }
        }
      };

      ws.onerror = e => console.error("ðŸš¨ WS error", e);
      ws.onclose = () => console.log("ðŸ”Œ WS closed");
    })();
  </script>
</body>
</html>
