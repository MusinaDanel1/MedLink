<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ü—Ä–∏—ë–º: –í–∏–¥–µ–æ + –ß–∞—Ç</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { width:100%; height:100%; overflow:hidden; font-family:Arial,sans-serif }
    body { display:flex; }

    /* === –í–∏–¥–µ–æ –æ–±–ª–∞—Å—Ç—å === */
    .video-container {
      position:relative; flex:1; background:#000;
      display:grid; place-items:center;
    }
    #remote {
      width:100%; height:100%; object-fit:cover; background:#000;
    }
    .local {
      position:absolute; bottom:80px; right:20px;
      width:160px; height:120px; border:2px solid #fff;
      border-radius:8px; overflow:hidden; background:#222;
    }
    .local video { width:100%; height:100%; object-fit:cover }
    .controls {
      position:absolute; bottom:20px; left:50%;
      transform:translateX(-50%); display:flex; gap:16px;
      background:rgba(0,0,0,0.5); padding:8px 16px; border-radius:32px;
    }
    .controls button {
      width:48px; height:48px; border:none; border-radius:50%;
      background:#fff; cursor:pointer; font-size:20px;
      display:flex; align-items:center; justify-content:center;
    }
    .controls button.end { background:#e53935; color:#fff; }

    /* === –ß–∞—Ç === */
    .sidebar {
      width:300px; display:flex; flex-direction:column;
      border-left:1px solid #ddd; background:#f5f5f5;
    }
    .chat-header {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px; background:#fff; border-bottom:1px solid #ddd;
    }
    .chat-header .title {
      font-size:16px; font-weight:bold; color:#202124;
    }
    .chat-header .close {
      font-size:18px; cursor:pointer; color:#5f6368;
    }
    #msgList {
      flex:1; padding:12px; overflow-y:auto;
      background:#f0f0f0; 
    }
    .message {
      display:flex; margin-bottom:8px;
    }
    .message.other { justify-content:flex-start }
    .message.me    { justify-content:flex-end }
    .message .bubble {
      max-width:70%; padding:8px 12px; border-radius:16px;
      font-size:14px; line-height:1.4;
      position: relative;
    }
    .message .bubble .sender {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
      font-weight: bold;
    }
    .message.other .bubble {
      background:#fff; color:#202124; border-top-left-radius:4px; margin-left:8px;
    }
    .message.me .bubble {
      background:#dcf8c6; color:#202124; border-top-right-radius:4px; margin-right:8px;
    }
    .chat-input {
      display:flex; padding:8px 12px; background:#fff;
      border-top:1px solid #ddd;
    }
    .chat-input input {
      flex:1; padding:8px; border:1px solid #ccc;
      border-radius:20px; outline:none;
      font-size:14px; margin-right:8px;
    }
    .chat-input button {
      width:40px; height:40px; border:none;
      background:#888; color:#fff; border-radius:50%;
      cursor:pointer; font-size:16px;
    }
  </style>
</head>
<body>

  <!-- –í–∏–¥–µ–æ-–∫–ª–∏–µ–Ω—Ç -->
  <div class="video-container">
    <video id="remote" autoplay playsinline></video>
    <div class="local">
      <video id="local" autoplay muted playsinline></video>
    </div>
    <div class="controls">
      <button id="toggleMic">üé§</button>
      <button id="toggleCamera">üì∑</button>
      <button id="endCall" class="end">‚èπÔ∏è</button>
    </div>
  </div>

  <!-- –ß–∞—Ç-–±–æ–∫–æ–≤–∏–∫ -->
  <div class="sidebar">
    <div class="chat-header">
      <div class="title">–ß–∞—Ç</div>
      <div class="close" onclick="window.close()">√ó</div>
    </div>
    <div id="msgList"></div>
    <div class="chat-input">
      <input id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" />
      <button id="sendBtn">‚û§</button>
    </div>
  </div>

  <script>
  (async function(){
    const params = new URLSearchParams(location.search);
    const apptID = params.get("id") || "1";
    const role   = params.get("role") || "patient";
    const apiBaseUrl = `${location.protocol}//${location.hostname}:8080`;
    const wsUrl  = `${location.protocol.replace("http","ws")}//${location.hostname}:8080/ws?appointment_id=${apptID}&role=${role}`;

    console.log("‚ñ∂Ô∏è init", { apptID, role, wsUrl, apiBaseUrl });

    // -- WebRTC setup (—Ç–æ—Ç –∂–µ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–ª) --
    const pc = new RTCPeerConnection({
      iceServers:[{urls:"stun:stun.l.google.com:19302"}]
    });
    pc.onicecandidate = ({candidate})=>{
      console.log("ice:",candidate);
      if(candidate && ws.readyState===1)
        ws.send(JSON.stringify({type:"candidate",data:candidate}));
    };
    pc.ontrack = e=>{
      console.log("got remote",e.streams[0]);
      document.getElementById("remote").srcObject = e.streams[0];
    };

    let localStream;
    try {
      localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      document.getElementById("local").srcObject = localStream;
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    } catch(e){ return console.error(e); }

    const ws = new WebSocket(wsUrl);
    ws.onopen = async ()=>{
      console.log("WS open");
      if(role==="doctor"){
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({type:"offer",data:offer}));
      }
    };
    ws.onmessage = async ({data})=>{
      const msg = JSON.parse(data);
      console.log("WS msg",msg);
      if(msg.type==="offer"){
        await pc.setRemoteDescription(msg.data);
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        ws.send(JSON.stringify({type:"answer",data:ans}));
      } else if(msg.type==="answer"){
        await pc.setRemoteDescription(msg.data);
      } else if(msg.type==="candidate"){
        try{ await pc.addIceCandidate(msg.data) }
        catch(e){console.warn(e)}
      }
    };
    ws.onerror = e=>console.error(e);
    ws.onclose = ()=>console.log("WS closed");

    document.getElementById("toggleMic").onclick = ()=>{
      const t=localStream.getAudioTracks()[0]; t.enabled=!t.enabled;
      document.getElementById("toggleMic").style.opacity=t.enabled?1:0.5;
    };
    document.getElementById("toggleCamera").onclick = ()=>{
      const t=localStream.getVideoTracks()[0]; t.enabled=!t.enabled;
      document.getElementById("toggleCamera").style.opacity=t.enabled?1:0.5;
    };
    document.getElementById("endCall").onclick = ()=>{
      pc.close(); ws.close();
    };

    // -- Chat logic --
    async function sendMessage(text) {
      try {
        console.log("Sending message as:", role);
        const res = await fetch(`${apiBaseUrl}/api/appointments/${apptID}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sender: role.toLowerCase(),
            content: text
          })
        });
        
        if (!res.ok) {
          console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", await res.text());
          return null;
        }
        
        const result = await res.json();
        console.log("Message sent:", result);
        return result;
      } catch(e) {
        console.error("Error sending message:", e);
        return null;
      }
    }

    const msgList = document.getElementById("msgList");
    const inp = document.getElementById("msgInput");
    document.getElementById("sendBtn").onclick = async () => {
      const txt = inp.value.trim();
      if (!txt) return;
      
      const result = await sendMessage(txt);
      if (result) {
        inp.value = "";
        await loadChat(); // Reload messages after successful send
      }
    };

    async function loadChat() {
      try {
        const res = await fetch(`${apiBaseUrl}/api/appointments/${apptID}/messages`);
        if (!res.ok) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", await res.text());
          return;
        }
        
        const messages = await res.json();
        console.log("Loaded messages:", messages);
        
        if (!Array.isArray(messages)) {
          console.error("Invalid messages format:", messages);
          return;
        }

        msgList.innerHTML = messages.map(m => {
          console.log("Processing message:", m, "Current role:", role);
          
          // Convert both role and sender to lowercase for comparison
          const isMe = m.sender.toLowerCase() === role.toLowerCase();
          const cls = isMe ? "me" : "other";
          
          // Set sender label based on the message sender and current role
          let senderLabel;
          if (m.sender.toLowerCase() === "doctor") {
            senderLabel = isMe ? "–í—ã" : "–î–æ–∫—Ç–æ—Ä";
          } else if (m.sender.toLowerCase() === "patient") {
            senderLabel = isMe ? "–í—ã" : "–ü–∞—Ü–∏–µ–Ω—Ç";
          } else if (m.sender.toLowerCase() === "bot") {
            senderLabel = "–°–∏—Å—Ç–µ–º–∞";
          } else {
            console.warn("Unknown sender:", m.sender);
            senderLabel = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
          }
          
          return `<div class="message ${cls}">
            <div class="bubble">
              <div class="sender">${senderLabel}</div>
              ${m.content || ""}
            </div>
          </div>`;
        }).join("");
        
        msgList.scrollTop = msgList.scrollHeight;
      } catch(e) {
        console.error("Error loading chat:", e);
      }
    }

    loadChat();
    setInterval(loadChat, 3000);

    // Add Enter key support
    inp.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        document.getElementById("sendBtn").click();
      }
    });
  })();
  </script>
</body>
</html>
