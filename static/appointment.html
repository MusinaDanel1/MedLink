<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>–ü—Ä–∏—ë–º: –í–∏–¥–µ–æ + –ß–∞—Ç</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    html, body { width:100%; height:100%; overflow:hidden; font-family:Arial,sans-serif }
    body { display:flex; }

    /* –ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –≤–∏–¥–µ–æ */
    .video-container {
      position:relative;
      flex:1;
      background:#000;
      display:grid;
      place-items:center;
    }
    #remote {
      width:100%; height:100%;
      object-fit:cover;
      background:#000;
    }
    .local {
      position:absolute;
      bottom:80px; right:20px;
      width:160px; height:120px;
      border:2px solid #fff;
      border-radius:8px;
      overflow:hidden;
      background:#222;
    }
    .local video { width:100%; height:100%; object-fit:cover }
    .controls {
      position:absolute;
      bottom:20px; left:50%;
      transform:translateX(-50%);
      display:flex; gap:16px;
      background:rgba(0,0,0,0.5);
      padding:8px 16px;
      border-radius:32px;
    }
    .controls button {
      width:48px; height:48px;
      border:none; border-radius:50%;
      background:#fff; cursor:pointer;
      font-size:20px;
      display:flex; align-items:center; justify-content:center;
    }
    .controls button.end {
      background:#e53935; color:#fff;
    }

    /* –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —á–∞—Ç */
    .sidebar {
      width:300px;
      display:flex; flex-direction:column;
      border-left:1px solid #333;
      background:#f5f5f5;
    }
    .chat-header {
      padding:12px; background:#6200ee; color:#fff;
      text-align:center; font-weight:bold;
    }
    #msgList {
      flex:1; padding:8px 12px; overflow-y:auto;
      background:#fff;
    }
    .chat-input {
      display:flex; padding:8px 12px; background:#eee;
    }
    .chat-input input {
      flex:1; padding:8px; border:1px solid #ccc;
      border-radius:4px;
    }
    .chat-input button {
      margin-left:8px; padding:8px 12px;
      border:none; background:#6200ee; color:#fff;
      border-radius:4px; cursor:pointer;
    }
    .message {
      margin-bottom:8px;
    }
    .message .sender {
      font-weight:bold;
      margin-right:4px;
    }
  </style>
</head>
<body>

  <!-- VIDEO -->
  <div class="video-container">
    <video id="remote" autoplay playsinline></video>
    <div class="local">
      <video id="local" autoplay muted playsinline></video>
    </div>
    <div class="controls">
      <button id="toggleMic">üé§</button>
      <button id="toggleCamera">üì∑</button>
      <button id="endCall" class="end">‚èπÔ∏è</button>
    </div>
  </div>

  <!-- CHAT -->
  <div class="sidebar">
    <div class="chat-header">–ß–∞—Ç</div>
    <div id="msgList"></div>
    <div class="chat-input">
      <input id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
  (async function(){
    const params = new URLSearchParams(location.search);
    const apptID = params.get("id");
    const role   = params.get("role") || "patient";
    const wsUrl  = `${location.protocol.replace("http","ws")}//${location.host}`
                  + `/ws?appointment_id=${apptID}&role=${role}`;

    console.log("‚ñ∂Ô∏è init", { apptID, role, wsUrl });

    // 1) PeerConnection
    const pc = new RTCPeerConnection({
      iceServers: [{urls:"stun:stun.l.google.com:19302"}]
    });
    pc.onicecandidate = ({candidate}) => {
      console.log("üì® icecandidate", candidate);
      if (candidate && ws.readyState===1) {
        ws.send(JSON.stringify({type:"candidate",data:candidate}));
      }
    };
    pc.ontrack = e => {
      console.log("üëÄ got remote track", e.streams[0]);
      document.getElementById("remote").srcObject = e.streams[0];
    };

    // 2) Local media
    let localStream;
    try {
      localStream = await navigator.mediaDevices
        .getUserMedia({video:true,audio:true});
      console.log("üìπ got local stream", localStream);
      document.getElementById("local").srcObject = localStream;
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
    } catch(e) {
      return console.error("‚ùå getUserMedia failed", e);
    }

    // 3) Signaling WS
    const ws = new WebSocket(wsUrl);
    ws.onopen = async () => {
      console.log("üîó WS open");
      if (role==="doctor") {
        console.log("üë®‚Äç‚öïÔ∏è createOffer");
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        console.log("üì® send offer", offer);
        ws.send(JSON.stringify({type:"offer",data:offer}));
      }
    };
    ws.onmessage = async ({data}) => {
      const msg = JSON.parse(data);
      console.log("üì• WS message", msg);
      if (msg.type==="offer") {
        await pc.setRemoteDescription(msg.data);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        console.log("üì® send answer", answer);
        ws.send(JSON.stringify({type:"answer",data:answer}));
      }
      else if (msg.type==="answer") {
        await pc.setRemoteDescription(msg.data);
      }
      else if (msg.type==="candidate") {
        console.log("üëÇ addIceCandidate", msg.data);
        try { await pc.addIceCandidate(msg.data); }
        catch(e){ console.warn("‚ö†Ô∏è ICE failed", e) }
      }
    };
    ws.onerror = e => console.error("üö® WS error", e);
    ws.onclose = () => console.log("üîå WS closed");

    // 4) Controls
    document.getElementById("toggleMic").onclick = () => {
      const tr = localStream.getAudioTracks()[0];
      tr.enabled = !tr.enabled;
      console.log("üé§ mic", tr.enabled);
      document.getElementById("toggleMic").style.opacity = tr.enabled?1:0.5;
    };
    document.getElementById("toggleCamera").onclick = () => {
      const tr = localStream.getVideoTracks()[0];
      tr.enabled = !tr.enabled;
      console.log("üì∑ cam", tr.enabled);
      document.getElementById("toggleCamera").style.opacity = tr.enabled?1:0.5;
    };
    document.getElementById("endCall").onclick = () => {
      pc.close(); ws.close();
      console.log("‚èπÔ∏è call ended");
    };

    // 5) Chat
    const msgList = document.getElementById("msgList");
    const inp     = document.getElementById("msgInput");
    document.getElementById("sendBtn").onclick = async () => {
      const txt = inp.value.trim();
      if (!txt) return;
      await fetch(`/api/appointments/${apptID}/messages`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({sender:role,content:txt})
      });
      inp.value = "";
      loadChat();
    };
    async function loadChat() {
      try {
        const res = await fetch(`/api/appointments/${apptID}/messages`);
        const arr = await res.json();
        msgList.innerHTML = arr.map(m=>
          `<div class="message"><span class="sender">${m.sender}:</span> ${m.content}</div>`
        ).join("");
        msgList.scrollTop = msgList.scrollHeight;
      } catch(e) {
        console.error("‚ùå loadChat", e);
      }
    }
    loadChat();
  })();
  </script>
</body>
</html>
